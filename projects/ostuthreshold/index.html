<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>Android Development -- Ostu threshold - Shengting Cao&#39;s Note Book</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



  <meta name="generator" content="Hugo 0.58.2" />
  <meta itemprop="name" content="Android Development -- Ostu threshold">
<meta itemprop="description" content="Using Ostu threshold measure hight of person">


<meta itemprop="datePublished" content="2019-06-01T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-06-01T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1230">



<meta itemprop="keywords" content="" />

  <meta property="og:title" content="Android Development -- Ostu threshold" />
<meta property="og:description" content="Using Ostu threshold measure hight of person" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shengtingcao.top/projects/ostuthreshold/" />
<meta property="article:published_time" content="2019-06-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-06-01T00:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android Development -- Ostu threshold"/>
<meta name="twitter:description" content="Using Ostu threshold measure hight of person"/>

  

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
  
    
      <link rel="stylesheet" href="/css/normalize.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css">
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" integrity="sha384-i1LQnF23gykqWXg6jxC2ZbCbUMxyw5gLZY6UiUS98LYV5unm8GWmfkIS6jqJfb4E" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
      
      
      <link rel="stylesheet" href="/css/main.min.0a64f3eede6e78edc2d8b2ca7051e4d9a6379f472dac76b1168733b88d27146a.css" integrity="sha256-CmTz7t5ueO3C2LLKcFHk2aY3n0ctrHaxFoczuI0nFGo=">
      <link rel="stylesheet" href="/css/add-on.css">
    
  
  
  
  
</head>

  <body>
    
<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/">
        
          
            projects
          
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu">
      
        
          
          
            <a href="/" class="link"><i class='far fa-id-card'></i> Bio</a>
          
        
      
        
          
          
            <a href="/projects/" class="link"><i class='far fa-newspaper'></i> Projects</a>
          
        
      
        
          
          
            <a href="/categories/" class="link"><i class='fas fa-sitemap'></i> Categories</a>
          
        
      
      <a href="#share-menu" class="share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
      
<a href="/search/" class="link"><i class="fas fa-search"></i> Search</a>

    </menu>
    
<a href="/search/" class="link"><i class="fas fa-search"></i> Search</a>

    <a href="#share-menu" class="share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
    <a href="#lang-menu" class="lang-toggle" lang="en">en</a>
    <a href="#site-nav" class="nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  <menu id="lang-menu" class="flyout-menu">
  <a href="#" lang="en" class="link active">English (en)</a>
  
    
      
    
      
        <a href="/jp" lang="jp" class="no-lang link">日本語 (jp)</a>
      
    
      
        <a href="/cn" lang="cn" class="no-lang link">中文 (cn)</a>
      
    
  
  
</menu>

  
    <menu id="share-menu" class="flyout-menu">
      <h1>Share Post</h1>
      





    </menu>
  
</header>

    <div id="wrapper">
      <section id="site-intro">
  <a href="/"><img src="/img/main/logo.jpg" class="circle" width="100" alt="Debug the world! Touch the theory!" /></a>
  <header>
    <h1>曹胜庭 Shengting Cao</h1>
  </header>
  <main>
    <p>Debug the world! Touch the theory!</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        
        <li><a href="//github.com/scao7" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//linkedin.com/in//shengting-steven-cao-aa5672136" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>







<li><a href="//youtube.com/channel/UCDItL8_wS1VLYaSrT6m9BFA" target="_blank" rel="noopener" title="YouTube" class="fab fa-youtube"></a></li>


















<li><a href="mailto:codescao7@gmailcom" target="_blank" title="Email" class="far fa-envelope"></a></li>

      </ul>
    </footer>
  
</section>

      <main id="site-main">
        <article class="post">
  <header>
  <div class="title">
    
        <h2><a href="/projects/ostuthreshold/">Android Development -- Ostu threshold</a></h2>
    
    
        <p>Using Ostu threshold measure hight of person</p>
    
</div>
  <div class="meta">
    <time class="published" datetime="2019-06-01 00:00:00 &#43;0000 UTC">
      June 1, 2019
    </time>
    <span class="author">Shengting Cao</span>
    
      <p>6 minutes read</p>
    
  </div>
</header>

  <section id="socnet-share">
    





  </section>
  

  <div class="content">
    

<h4 id="problem-description">Problem Description</h4>

<p>I am facing the problem to build an Android App to measure a person&rsquo;s waistline, height and hip data. The first step is to find a correct threshold method to generate a good picture for us to build further algorithms.</p>

<h4 id="theory">Theory</h4>

<p>All the Theory of Ostu Threshold is from this paper: <a href="http://webserver2.tecgraf.puc-rio.br/~mgattass/cg/trbImg/Otsu.pdf">Ostu&rsquo;s paper</a>. And the reference <a href="http://hipersayanx.blogspot.com/2016/08/otsu-threshold.html">JavaScript page</a>.</p>

<h4 id="implementation">implementation</h4>

<p>First, I tried to implement the basic code for threshold of a certain value for example: 100.
Here is the Java Code in Android Studio</p>

<pre><code class="language-java">public  static Bitmap converImage(Bitmap original){
        Bitmap finalImage = Bitmap.createBitmap(original.getWidth(), original.getHeight(),original.getConfig());
        int colorPixel;
        int A,R,G,B;
        int width = original.getWidth();
        int height = original.getHeight();
        for(int x = 0; x &lt; width; x++ ){
            for(int y = 0 ; y &lt; height; y++){
                colorPixel = original.getPixel(x,y);
                A = Color.alpha(colorPixel);
                R = Color.red(colorPixel);
                G = Color.green(colorPixel);
                B = Color.blue(colorPixel);

                if(R &gt; 100 ){
                    R = 255;
                }
                else{
                    R = 0;
                }
                G= R;
                B= R;
                finalImage.setPixel(x,y,Color.argb(A,R,G,B));
            }
        }

        return finalImage;
    }
</code></pre>

<h4 id="modify-the-fixed-threshold-into-ostu-threshold">Modify the fixed threshold into Ostu threshold</h4>

<p>This is the method that applied the Ostu threshold for the colored image</p>

<pre><code class="language-java">public static Bitmap ostuConvert(Bitmap original){
      Bitmap BWimg = Bitmap.createBitmap(original.getWidth(), original.getHeight(), original.getConfig());
      int width = original.getWidth();
      int height = original.getHeight();
      int A, R, G, B, colorPixel;

      double Wcv = 0, th = 0;
      int[] tPXL = new int[256];
      int[][] pxl = new int[width][height];
      double Bw, Bm, Bv, Fw, Fm, Fv;
      int np, ImgPix = 0, fth = 0;

      // pixel check for histogram //
      for (int x = 0; x &lt; width; x++) {
          for (int y = 0; y &lt; height; y++) {

              colorPixel = original.getPixel(x, y);

              A = Color.alpha(colorPixel);
              R = Color.red(colorPixel);
              G = Color.green(colorPixel);
              B = Color.blue(colorPixel);

              int gray = (int) ( (0.2126 * R) + (0.7152 * G) + (0.0722 * B) ); // (int) ( (0.299 * R) + (0.587 * G) + (0.114 * B) );
              pxl[x][y] = gray;
              tPXL[gray] = tPXL[gray] + 1;
              ImgPix = ImgPix + 1;
          }
      }
      // ----- histo-variance ----- //
      for (int t = 0; t &lt; 256; t++){
          Bw = 0; Bm = 0; Bv = 0;
          Fw = 0; Fm = 0; Fv = 0;
          np = 0;

          if (t == 0){ // all white/foreground as t0 ----- //
              Fw = 1;

              for (int d = 0; d &lt; 256; d++) { //mean
                  Fm = Fm + (d * tPXL[d]);
              }
              Fm = Fm / ImgPix;

              for (int e = 0; e &lt; 256; e++) { //variance
                  Fv = Fv + (Math.pow((e - Fm), 2) * tPXL[e]);
              }
              Fv = Fv / ImgPix;

          }
          else { // main thresholding
              for (int d = 0; d &lt; (t-1); d++){ // BG weight &amp; mean + BG pixel
                  Bw = Bw + tPXL[d];
                  Bm = Bm + (d * tPXL[d]);
                  np = np + tPXL[d];
              }
              Bw = Bw / ImgPix;
              Bm = Bm / np;

              for (int e = 0; e &lt; (t-1); e++) { //BG variance
                  Bv = Bv + (Math.pow((e - Bm), 2) * tPXL[e]);
              }
              Bv = Bv / np;

              for (int j = t; j &lt; 256; j++) { // FG weight &amp; mean + BG pixel
                  Fw = Fw + tPXL[j];
                  Fm = Fm + (j * tPXL[j]);
                  np = ImgPix - np;
              }
              Fw = Fw / ImgPix;
              Fm = Fm / np;

              for (int k = t; k &lt; 256; k++) { //FG variance
                  Fv = Fv + (Math.pow((k - Fm), 2) * tPXL[k]);
              }
              Fv = Fv / np;

          }

          // within class variance
          Wcv = (Bw * Bv) + (Fw * Fv);

          if (t == 0){
              th = Wcv;
          }
          else if (Wcv &lt; th){
              th = Wcv;
              fth = t;
          }
      }

      // set binarize pixel
      for (int x = 0; x &lt; width; x++) {
          for (int y = 0; y &lt; height; y++) {

              int fnpx = pxl[x][y];
              colorPixel = original.getPixel(x, y);

              A = Color.alpha(colorPixel);

              if (fnpx &gt; fth) { //R &gt; fth
                  fnpx = 255;
                  BWimg.setPixel(x, y, Color.argb(A, fnpx, fnpx, fnpx));
              }
              else {
                  fnpx = 0;
                  BWimg.setPixel(x, y, Color.argb(A, fnpx, fnpx, fnpx));
              }
          }
      }
      return BWimg;
  }
</code></pre>

<h4 id="height-calculation">Height Calculation</h4>

<p>The Height Calculation is just count the pixel in the height. So we can apply the method above and change a little. In the last for loop: &ldquo;//set binarize pixel&rdquo; we modify the method as following:</p>

<pre><code class="language-java">    float top =  Float.POSITIVE_INFINITY;
    float bottom =  Float.NEGATIVE_INFINITY;
    // set binarize pixel
    for (int x = 0; x &lt; width; x++) {
       for (int y = 0; y &lt; height; y++) {

           int fnpx = pxl[x][y];
           colorPixel = original.getPixel(x, y);

           A = Color.alpha(colorPixel);

           if (fnpx &gt; fth) { //R &gt; fth
               fnpx = 255;
           }
           else {
               fnpx = 0;
               if(top &gt; y ){
                   top = y;
               }

               if(bottom &lt; y){
                   bottom = y;
               }

           }
       }
    }
    float[] pointsY = new float[]{ top * scaleFactor ,bottom * scaleFactor};

    return pointsY;
</code></pre>

<p>I defined the two float variable initialed as POSITIVE_INFINITY and NEGATIVE_INFINITY. When fnpx &lt;= fth begin to calculate the value. Find the minimun role and the maximum role.
I returned the float arrary represent two height value.
I should post the picture of processing but because of the privacy issue I won&rsquo;t post it until this research period end.</p>

<h4 id="draw-line-and-display-pixel-on-the-image-view">Draw line and display pixel on the image view</h4>

<p>After we have the value of top and bottom. I need to draw a red line on the image and display the pixel value between these two.</p>

<pre><code class="language-java">public static void drawHeight(ImageView imgView, Bitmap imageBitmap){
        Bitmap bitmap = Bitmap.createBitmap(imgView.getWidth(), imgView.getHeight(), Bitmap.Config.ARGB_8888);
        float scaleFactor = (float) bitmap.getHeight() / (float) imageBitmap.getHeight();
        float[] points =customizeMethod.ostuCalculateHeight(imageBitmap, scaleFactor);

        Canvas canvas = new Canvas(bitmap);
        imgView.draw(canvas);

        Paint paint = new Paint();
        paint.setColor(Color.RED);
        paint.setStrokeWidth(10);

        float middle = imgView.getWidth() / 2; //x value of the image

        canvas.drawLine(middle, points[0], middle, points[1], paint);
        String pixelInfo = (int)(points[1] - points[0]) + &quot;pixels&quot;;

        paint.setColor(Color.GREEN);
        paint.setTextSize(40);
        canvas.drawText(pixelInfo,middle, (points[0] + points[1])/2, paint);
        //draw line on image
        imgView.setImageBitmap(bitmap);
    }
</code></pre>

<p>I create this method to draw the height. There are two variable we need pass in: imgView and imageBitmap. ImageView refers the view you want to put picture, imageBitmap is the original image in Bitmap data structure.</p>

<h4 id="problems-remain-to-solve">Problems remain to solve</h4>

<h5 id="span-style-color-blue-runtime-span"><span style="color:blue">Runtime</span></h5>

<p>So far, my app works for measure the height of a person in most circumstance. But the runtime is very slow because I put all the calculation in one thread. There are two option to make the calculation fast. The first one is parallel computing. The second is to use the alternative OpenCV solution, it might faster than my solution. So next post I will focus on how to do parallel computing on Android software and how to load OpenCV library and apply the method.</p>

<h5 id="span-style-color-blue-accurate-of-measurement-span"><span style="color:blue">Accurate of measurement</span></h5>

<p>For my application, there still some in accurate value because of the limitation of Ostu threshold method. If a person waring dark cloth and has white hair the output will be inaccurate. Therefore, to increase the accurate of the measurement. I need implement another image processing method called Image gradient. I will introduce the implementation in next blog post.</p>

<h4 id="update">Update</h4>

<p>After learning opencv there are a faster way to solve the ostu threshold method. The updated code using OpenCV library. Run time is less than 1s.</p>

<pre><code class="language-java">private void ostuThreshold(){
    Bitmap bitmap = BitmapFactory.decodeResource(getResources(),images[current_image]);
    Mat Rgba = new Mat();
    Mat ostuMat = new Mat();
    Utils.bitmapToMat(bitmap,Rgba);
    Imgproc.cvtColor(Rgba,ostuMat,Imgproc.COLOR_RGBA2GRAY,0);
    Imgproc.threshold(ostuMat,ostuMat,0,255,Imgproc.THRESH_OTSU);
    Bitmap outputhBitmap = Bitmap.createBitmap(bitmap.getWidth(),bitmap.getHeight(),Bitmap.Config.RGB_565);
    Utils.matToBitmap(ostuMat,outputhBitmap);
    imageView.setImageBitmap(outputhBitmap);
}
</code></pre>

  </div>
  <footer>
    <ul class="stats">
  
    
    
      <li class="categories">
        <ul>
          
            
            <li><a class="article-category-link" href="https://shengtingcao.top/categories/android-development">Android Development</a></li>
          
        </ul>
      </li>
    
  
  
    <li class="tags">
      <ul>
        <li>None</li>
      </ul>
    </li>
  
</ul>

  </footer>
</article>


<div class="pagination">
  
    <a href="/projects/importopencv/" class="button big previous"><i class="fas fa-angle-left"></i> Android Development -- Import OpenCV</a>
  
  
    <a href="/projects/opencvbasiclibraryintroandroid/" class="button big next">Android Development -- Image Tools <i class="fas fa-angle-right"></i></a>
  
</div>


      </main>
      <section id="site-sidebar">
  

  
    
      <section id="categories">
        <header>
          <h1><a href="/categories">Categories</a></h1>
        </header>
        <ul>
          
            
          
          
          <li>
            
              <a href="/categories/computer-graphics/">computer-graphics<span class="count">6</span></a>
            
          
          <li>
            
              <a href="/categories/android-development/">android-development<span class="count">5</span></a>
            
          
          <li>
            
              <a href="/categories/computer-vision/">computer-vision<span class="count">3</span></a>
            
          
          <li>
            
              <a href="/categories/programming-languages/">programming-languages<span class="count">3</span></a>
            
          
          <li>
            
              <a href="/categories/latex/">latex<span class="count">2</span></a>
            
          
          <li>
            
              <a href="/categories/deep-learning/">deep-learning<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/game-development/">game-development<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/github/">github<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/internet-ssh/">internet-ssh<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/linux/">linux<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/machine-learning/">machine-learning<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/probability/">probability<span class="count">1</span></a>
            
          
          </li>
        </ul>
      </section>
    
  

  <section id="mini-bio">
    <header>
      <h1>About</h1>
    </header>
    <p>Hugo is the tool I have used to build this website.</p>
    <footer>
      <a href="/about" class="button">Learn More</a>
    </footer>
  </section>
</section>

      <footer id="site-footer">
  
      <ul class="socnet-icons">
        
        <li><a href="//github.com/scao7" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//linkedin.com/in//shengting-steven-cao-aa5672136" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>







<li><a href="//youtube.com/channel/UCDItL8_wS1VLYaSrT6m9BFA" target="_blank" rel="noopener" title="YouTube" class="fab fa-youtube"></a></li>


















<li><a href="mailto:codescao7@gmailcom" target="_blank" title="Email" class="far fa-envelope"></a></li>

      </ul>
  
  <p class="copyright">
    
      &copy; 2022
      
        Shengting Cao&#39;s Note Book
      
    . <br>
    Theme: <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>A <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP port</a> | Powered by <a href='https://gohugo.io/' title='0.58.2' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>

<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>


<!DOCTYPE html>

<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

  </head>
</html>

      
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/vbscript-html.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/matlab.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>
  <script src=/js/util.js></script>
  <script src=/js/main.js></script>
  <script src=/js/add-on.js></script>
  





    </div>
  </body>
</html>
